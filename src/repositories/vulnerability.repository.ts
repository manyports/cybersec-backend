import { PrismaClient, Prisma } from '@prisma/client';
import { Vulnerability } from '../types';

export class VulnerabilityRepository {
  constructor(private prisma: PrismaClient) {}

  async findAll() {
    return this.prisma.vulnerability.findMany({
      orderBy: { created_at: 'desc' }
    });
  }

  async saveMany(vulnerabilities: Omit<Vulnerability, 'id' | 'created_at' | 'updated_at'>[]): Promise<void> {
    await this.prisma.$transaction(async (prisma) => {
      await prisma.vulnerability.deleteMany({
        where: { source: 'sploitus.com' }
      });

      await prisma.vulnerability.createMany({
        data: vulnerabilities.map(v => ({
          ...v,
          id: crypto.randomUUID()
        }))
      });
    });
  }
}